---
title: 'Hockey Team Success: A Sum of Its Parts'
author: "Molly McNamara"
output:
  html_document: default
  word_document: default
---
# Hockey and the Potential Impact of Data Science

The National Hockey League (NHL) is considered to be one of the four major professional sports leagues in the United States (though ranked behind baseball, football and basketball). The NHL is a binational entity split between the US and Canada, where hockey is by far the most popular sport. The economics of hockey are complicated by the shared border and exchange rates, but team success ultimately drives financial success for the team and the league. Teams see an impact of improved performance and win totals on season ticket sales and sponsorship revenue.

Establishing the right balance of player skills and team needs to make a successful run at the playoffs is the challenge of every NHL general manager (GM). While in-game coaching decisions are left to the coaching staff, the GM is responsible for acquiring and dismissing players as well as the coach. A skilled GM evaluates the existing team members and identifies gaps or needs in order to find and obtain talent that will support and improve the team as a whole. Better analysis of player and league data can help guide a GM in improved decision making when acquiring team talent, hopefully resulting in a more successful team.

# The Data

The project dataset is a combination of NHL player and team statistics for years 2000-2011 and NHL draft data from the late 1980s through 2010. Variables include player names, ages and birthdates, countries of origin, positions played, scoring and defensive statistics by year, junior level and NHL teams and leagues played in, coaching records, and more. The information was gathered from several sources and in several separate files and formats.  

### Data Wrangling

Player/team statistical data was available in CSV format, separated into files by topic; draft data required download, compilation in a TXT file and conversion of the entire dataset to CSV.

Four files were combined to create the final cleaned dataset for analysis: Master (basic demographic information on all NHL players from 1908 to 2011), Scoring (scoring statistics for all NHL players from 1908 to 2011), Teams (team statistics and playoff outcomes from 1908 to 2011), and Draft (player draft information from 1979 to 2010). The date range for draft data was determined by identifying the earliest drafted player still playing in the period of interest for this project (the project will evaluate game data from 2000-2011 - a player drafted in 1979 was still playing in 2000) and the latest possible drafted player who would play in this time period (2010). Note that there is no data for 2004 due to a league-wide labor dispute (lockout) wherein the entire season was cancelled and no games were played.

The R packages used for data wrangling were as follows:

```{r, echo=TRUE}
library(dplyr)
library(readr)
library(tidyr)
library(countrycode)
```

Columns for all 4 files were renamed to understand the variables more easily. Columns for player name-ID and amateur team-league were split into their separate components. 

Unnecessary or duplicative variables were removed. Multiple fields were converted to factors or integers as appropriate. Birth and death month/day/year columns were joined into a single date column for each event. The datasets were subset to the years 2000 to 2011.

The datasets were evaluated with the summary() command to assess the presence of any obvious outliers. NA values in both sets were identified. In the case of certain variables, such as death statistics, NA is appropriate as most of the players in the subset timeframe had not yet died. Scoring statistics that displayed NA incorrectly (for example, a player did not score any goals in a given year) were replaced with a 0.

New variables were created for team playoff success, birth regions, draft round, and additional scoring statistics. Finally, the cleaned datasets were merged by year and team and the new cleaned data file was written and saved as CSV file.

### Final Dataset Composition

The variables in the final dataset are as follows:
Team ID, Conference and Division  
Team Season end rank and Playoff result  
Team made playoffs (0 or 1)  
Team Games, Wins, Losses, Ties, Overtime Losses, Points, Shootout Wins and Shootout Losses  
Team Goals For and Goals Against  
Team Penalty Minutes and Bench Minors  
Year (Season)  
Player ID  
First Name and Last Name  
Height and Weight  
Shooting Hand  
First and Last NHL season  
Years of Experience
Position Played  
Birth Country, Birth State/Province, Birth City  
Death Country, Death State/Province, Death City  
Birthdate and Deathdate  
Birth Region  
Stint with team  
Games Played  
Goals, Assists and Points  
Penalty Minutes  
Plus Minus Rating
Powerplay Goals and Assists  
Shorthanded Goals and Assists  
Gamewinning Goals and Gametying Goals  
Shots  
Goals and Shots Per Game  
Percent of Team Goals Scored  
Percent of Team Games Played  
Draft Pick and Draft Round  
Draft Year  
Draft Team  
Draft Age  
Amateur Team and League  

## Limitations

Several limitations can be identfied in the final dataset at this point: (a) the lack of player statistics prior to draft and draft combine results (the latter is kept confidential by the NHL), which could have been useful in predicting future NHL performance and team success; (b) this data largely ignores the defensive contribution of goaltenders by omission of goaltending statistics; and (c) Time On Ice (TOI), a well-known parameter of player performance, was not available.

# Preliminary Exploration

```{r, include=FALSE}
## Load additional data package
library(ggplot2)

## Import the data.  Fix an extra column that keeps importing from the CSV. 
Hockey <- read_csv("~/Desktop/FinalData_clean.csv")
Hockey <- select(Hockey, -X1)
## Create a subset that only includes the first instance of each player. This way analysis of certain attributes is not skewed by multiple seasons of play by a player.
ByPlayer <- Hockey[match(unique(Hockey$Player_ID), Hockey$Player_ID),]
library(rworldmap)
data(countryExData)
library(data.table)
BirthCountries <- setDT(ByPlayer)[, .N, by=Birth_Country]
colnames(BirthCountries) <- c("Birth_Country", "NumberofPlayers")
MapData <- joinCountryData2Map(BirthCountries
                             ,joinCode = "NAME"
                             ,nameJoinColumn = "Birth_Country")
```
The purpose of the initial data exploration was to screen for any obvious trends in the data and evaluate the relationships between player demographics and characteristics and teams making the playoffs.  

Player birth countries were mapped to a world map to evaluate the many origins of players in this dataset.
```{r, echo=FALSE}
mapCountryData(MapData
               ,nameColumnToPlot='NumberofPlayers', catMethod = "fixedWidth")
```

While it appears drafted players originate from many different countries, the NHL is based in the US and Canada; it might be useful to see regionally where the most players come from.
```{r, echo=FALSE}
ggplot(ByPlayer, aes(x = BirthRegion)) + geom_histogram(stat="count")
```

The Americas and Europe generate the vast majority of players drafted in the NHL. 

Draft statistics were initially evaluated by viewing a distribution of the draft rounds of the players in this dataset.
```{r, echo=FALSE}
ggplot(ByPlayer, aes(x = Draft_Round)) + geom_bar()
```

The draft round in the dataset appears to be skewed towards earlier rounds. A comparison between draft round and active years (up to 2012) in the NHL supports the idea that players from earlier draft rounds may have somewhat longer NHL careers.
```{r, echo=FALSE}
YearsPlayed = ByPlayer$LastNHLseason - ByPlayer$FirstNHLseason
ggplot(ByPlayer, aes(x = Draft_Round, y = YearsPlayed)) + geom_jitter() + geom_smooth(method = lm)
```

Another way to evaluate relationship between player draft position and team playoff success might be to see if higher-drafted players score more goals per game. It does look like there is a slight trend for more goals per game from higher-drafted players but it's not clear if this impacts making the playoffs.
```{r, echo=FALSE}
ggplot(Hockey, aes(x = Draft_Pick, y=GoalsPerGame, col=Playoffs)) + geom_point(alpha = 0.5, position = "jitter") + geom_smooth(method = lm)
```

It should be expected that teams who score more goals in a year and allows less goals in a year are more likely to go to the playoffs.
```{r, echo=FALSE}
ggplot(Hockey, aes(x = Year, y=Team_GoalsFor, col = Playoffs)) + geom_point()
ggplot(Hockey, aes(x = Year, y=Team_GoalsAgainst, col = Playoffs)) + geom_point()
```

This hypothesis appears to be true for the highest goal-scoring teams and lowest goal-allowing teams year-to-year.

# Modeling Approach

In examining the data in more detail over the course of the wrangling and exploring exercises, several simple truths are clear: teams that win more games, score more goals and allow less goals by their opposition go to the playoffs.  However, as teams are built and restructured over years, the question still exists of what player characteristics contribute most strongly to success.  The main goal of the project remains the primary focus in the project proposal - to determine what factors contribute to regular season success that is realized in a playoff berth.

The project approach at this point is to:  
* Build the best predictive model of team success (defined as making the playoffs) from the player and draft characteristics.  
* A secondary aim will be to define underrated and overrated players, determined by draft position and scoring history, and evaluate if player performance at the time of the draft is predictable by amateur team, amateur league, nationality, position played or other factors.

##Machine Learning Approach to Capstone Project

The main question for this project was what player demographic/draft/play characteristics are most predictive of team success (making the playoffs). The secondary question is whether player characteristics at the time they are drafted into the league, using a subset of underperforming and overperforming players, was used to predict their future performance. As this is labeled data, it was approached as a supervised learning problem.

The player features (independent variables) used to predict team success were Shooting Hand, Years of Experience, Position Played, Birth Country, Birth Region, Games Played, Goals, Assists and Points, Penalty Minutes, Plus Minus Rating, Shots, Goals and Shots Per Game, Percent of Team Goals Scored, Percent of Team Games Played, Draft Pick and Draft Round, Draft Age, Amateur Team and Amateur League.

The player features (independent variables) that may be used to predict whether a player will over or under deliver in terms of performance post-draft were Height and Weight, Shooting Hand, Position Played, Birth Country, Birth Region, Draft Year, Draft Team, Draft Age, Amateur Team and Amateur League.

The primary question was assessed using several different types of algorithms to build a model that allows for less than linear relationships between the variables; model performance was assessed to determine what type of algorithm produces the best model. The secondary question was evaluated using logistic regression to determine how the variables may impact the final outcome of player performance.

Repeated k-fold cross-validation was used with the caret package to estimate model accuracy for the various models predicting team performance.  The logistic regression model for player performance was evaluated with a chi-squared test using ANOVA.

## Data Analysis
#R code necessary to analyze NHL data to address questions for capstone project

```{r, include=FALSE}
# load libraries
library(mlbench)
library(caret)
library(readr)
library(rpart)
library(dplyr)
library(C50)
library(plyr)
library(ipred)
library(e1071)
library(ROCR)
library(randomForest)

#Read data and ensure variables are correct format
FullData <- read.csv("~/Desktop/FinalData_clean.csv")
str(FullData)
FullData$Playoffs <- as.factor(FullData$Playoffs)
FullData$Birth_Country <-as.character(FullData$Birth_Country)
FullData$Position_Played <-as.character(FullData$Position_Played)

#Rename data
dataset <- FullData
```

#Set trainControl, seed and preProcess.  In this case, all models will be run with three separate 10-fold cross-validations as the resampling scheme.
```{r, echo=TRUE}
control <- trainControl(method="repeatedcv", number=10, repeats=3)
seed <- 7
preProcess=c("center", "scale")
```

```{r, echo=TRUE}
#Create the formula to evaluate the variables that may influence Playoffs
formula <- Playoffs ~ Shooting_Hand + YearsExperience + BirthRegion + Games_Played + Goals + Assists + Points + Penalty_Minutes + Plus_Minus + Shots + GoalsPerGame + ShotsPerGame + PointsPerGame + PercentGoals + PercentGames + Draft_Pick + Draft_Round + Draft_Age
```

# Logistic Regression Model
```{r, echo=TRUE}
set.seed(seed)
fit.glm <- train(formula, data=dataset, method="glm", trControl=control, na.action=na.pass)
print(fit.glm)
```


# Classification And Regression Tree Model
```{r, echo=TRUE}
set.seed(seed)
fit.cart <- train(formula, data=dataset, method="rpart", trControl=control, na.action = na.pass)
print(fit.cart)
```

# C5.0 (a method that constructs classifiers expressed as decision trees)
```{r, echo=TRUE}
set.seed(seed)
fit.c50 <- train(formula, data=dataset, method="C5.0", trControl=control, na.action = na.pass)
print(fit.c50)
```

# Bagged CART (a bootstrap aggregating algorithm)
```{r, echo=TRUE}
set.seed(seed)
fit.treebag <- train(formula, data=dataset, method="treebag", trControl=control, na.action = na.pass)
print(fit.treebag)
```

# Random Forest
```{r, echo=TRUE}
set.seed(seed)
fit.rf <- train(formula, data=dataset, method="rf", trControl=control, na.action = na.omit)
print(fit.rf)
```

# Stochastic Gradient Boosting (Generalized Boosted Modeling - a model that constructs additive regression models on repeated subsamples of the data)
```{r, echo=TRUE}
set.seed(seed)
fit.gbm <- train(formula, data=dataset, method="gbm", trControl=control, verbose=FALSE, na.action = na.pass)
print(fit.gbm)
```

# Compile the resamples results from the models
```{r, echo=TRUE}
results <- resamples(list(logistic=fit.glm, cart=fit.cart, c50=fit.c50,
                          bagging=fit.treebag, rf=fit.rf, gbm=fit.gbm))
```

# Compare method accuracy
```{r, echo=TRUE}
summary(results, metric="Accuracy")
```

```{r, echo=TRUE}
# Boxplot comparison of methods
bwplot(results)
# Dot-plot comparison of methods
dotplot(results)
```

#Some further investigation of the linear regression model
```{r, echo=TRUE}
summary(fit.glm)
```


#Try to re-create the logistic regression model more simply to address potential overfitting
```{r, echo=TRUE}
set.seed(seed)
Logmodel <- glm(formula, family="binomial", dataset)
summary(Logmodel)
anova(Logmodel, test ="Chisq")
varImp(Logmodel)
```


### Question 2: Differences between Over and Underperforming Draft Picks

```{r, echo=TRUE}
#Determine average goals
summary(FullData$Goals)
```


#Set Over and Under Achievers: Players who were drafted early and score less than average goals & players who were drafted late who score more than average
```{r, echo=TRUE}
Under  <- subset(FullData, Draft_Round <= 2 & Goals <=6.68)
Over <- subset(FullData, Draft_Round >= 7 & Goals >=6.68)
```


#Create one data file with a variable to identify over or underachieverfs
```{r, echo=TRUE}
Question2 <- rbind(Under, Over)
Question2 <- mutate(Question2, OverUnder = as.numeric(Question2$Draft_Round <=2))
OverUnder <- c("OverUnder")
Question2[OverUnder][is.na(Question2[OverUnder])] <- 0
Question2$OverUnder <- as.factor(Question2$OverUnder)
```


#Logistic regression model
```{r, echo=TRUE}
PerfModel <- glm(OverUnder ~ Height + Weight + Position_Played + BirthRegion + Draft_Team + Draft_Age + AmateurLeague, family="binomial", Question2)
summary(PerfModel)
```


#Further evaluate model components
```{r, echo=TRUE}
anova(PerfModel, test="Chisq")
```


## Conclusions

###References

Player and team statistics was obtained from: The Hockey Database([link](http://www.opensourcesports.com/hockey/)) by Doug Reynolds, via Open Source Sports.  
Draft data was obtained from: Sports Reference LLC. "NHL Entry And Amateur Draft History." Hockey-Reference.com - Hockey Statistics and History([link](http://www.hockey-reference.com/)). 

All prior project reports, original and final data files, and R code can be found in the project Github repository.[link](https://github.com/bouncebarkrun/SpringboardCapstoneProject)
